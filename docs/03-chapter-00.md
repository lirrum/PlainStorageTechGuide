# 第0章:初识储电

想必各位读者对“储电”这个词并不陌生，目前它已经在整个MC技术圈流行开来，几乎每个玩生电/创电/棍电的都知道有这么个东西。本章作为系统学习储电的第一章，并不涉及过多的实践内容，将从储电的定义、历史、圈子、学习准备等方面展开叙述。读者需重点关注0.1（储电的定义）和0.3（储电前置学习）两个小节，其余部分可以先略读，在阅读了前面8章后再回过头来细读。

## 0.1 储电的定义

### 0.1.1 参考定义

目前并没有公认的标准储电定义，甚至很多储电圈内的学者对储电的范围都是模糊的，所以这里仅提供[储电的参考定义]<green>:[储电（Storage Tech），简称"ST"全称储存电路，是一门研究如何储存、运输和处理物品或容器的红石技术]<red>。储电是圈内常说的"红石六大分支"之一，是一门综合性的复杂技术。

然后列举一些圈内比较权威的研究者的定义：

- 储电就是“存”和“取”。 ——[Trice054](https://space.bilibili.com/353023126)
- 对于不同玩家来说，储电有不同的概念，如图:——[Zai_yu_you](https://space.bilibili.com/89892396)

![img预留位]()

定义本身并不重要，我们对于储电的理解都来源于研究经历和见闻，相信读者如果深入研究了储电，自然会明白储电到底是个什么东西，那时候这个定义也就不重要了。

### 0.1.2 储电与生电的联系

首先必须要明确的[是储电不是生电]<red>，二者不构成部分与整体的关系，都是红石领域中非常重要的主要分支。要厘清二者的关系需要知道[生电的定义(仅供参考)]<green>：[广义生电是指一切利用游戏机制达成某些目的，用以辅助生存的技术]<red>。其关注的重点是对游戏机制的挖掘、理解和运用，而储电则更关心物品的储存、运输和处理，这是最好辨别的点。

例如:一台带有收集的[EOL](https://www.bilibili.com/video/BV1Tk4y167aU)，它可以分成3个部分来看：一是刷怪部分，这里重点利用了光照更新机制、更新抑制/更新跳略和刷怪机制，几乎整个部分都是从代码里扣出来的，显然属于生电的范畴（[常见误区：生电并不一定要用到红石，尽管它是红石分支之一]<red>）；而收集系统则关注于对生成的产物的运输、打包、储存和综合管理等等（实际上更复杂），显然属于储电的领域；最难以界定的就是处死。这种大型收集的处死，既要研究如何高效低卡地处死怪物等生电问题，往往还要考虑产物的输出，这就涉及到矿车了，很多时候是储电问题，所以这一部分不好界定，往往视为储电和生电的融合部分，类似的例子还有很多。

其实在现实中也有这种分科，最好区别的就是数学和物理了，那这俩来类比想必很容易理解生电和储电的关系。生电是储电的基础之一，储电利用的所有机制都是生电研究出来的，好比物理的所有公式、图像本身就是数学的研究内容；储电在一定程度上也服务于生电，很多储电设施就是为了辅助生电而生的，最典型的例子就是收集；不过也有很多的储电内容与生电关联性不强，这就是圈内常提到的[“生储”]<green>和[“创储”]<green>。前者服务于生电或者需要考虑机器实装，后者更在意创新想法，不过个人认为分科分到储电这一级就够了，不用细分生创储。

此外，储电是从生电中脱离出来的（详见0.2），储电和生电的发展由相似之处，不过分开以后双方对彼此的影响其实很小。像更新抑制，对生电而言极其重要，但是谁要是在储电机器里用上这玩意，分分钟被同服后勤骂死。

说了这么多只是分别储电和生电的区别，二者没有高低贵贱之分[(反正都是牛马)]<deleteline>，都是MC中极其重要的技术领域，请勿刻意贬低或拔高某一方。

### 0.1.3 其他常见概念

- [加权数量]<green>:物品的堆叠数有64堆叠、16堆叠和不可堆叠，其对应的权重分别为1、4、64，而加权数量是物品原始数量 × 数量权重之和，例如：62个白桦木板 + 12个雪球 + 4把剪刀，其对应加权数量为 62×1 + 12×4 + 4×64 = 366。
- [信号强度]<green>:指红石粉/中继器和比较器的输出/充能方块的信号登记，常见取值集合为$ \\{n∈Z|1≤n≤15\\} $。
- [种]<green>:具有相同物品ID的物品算同种物品（NBT不同但ID相同的物品视实际情况而定，又是同种，有时不同种）。种数是指种的数量，也可以叫种类数。
- [类]<green>:具有相似特征的物品的集合。例如：不可堆叠类（共同特征是不可堆叠）、木头类（材质）、建筑方块类（用途）……类数是指类的数量。
- [组]<green>:加权数量 = 堆叠数量的物品集合。例如：1组雪球 = 16个雪球，1组红石块 = 64个红石块。

## 0.2 储电发展史

储电起源于约2020年，按时间先后顺序，我将储电发展大致分为了3个阶段：新生代、近代和现代，需要强调的是3个时期并无明显的分隔事件，并且现在储电的历史并不长，读者权当资料卡片看就行。

- 新生代

国内外储电史有很大的不同。国内在2018年左右生电开始萌芽，生产力大幅提高导致物资越发丰富，产生了2个需求:①分类储存管理物资 ②半/全自动处理物资。基于需求①，[新兵sinbing](https://space.bilibili.com/1446187)大佬在2020年研发出了国内公认的第一台流行大型综合型储存机器——[新兵全物品](https://www.bilibili.com/video/BV1dK411p7BK)。这一成就通常被视为国内储电史的开端，其重要性相当于阿拉伯数字于数学；基于需求②，[金合欢acaciachan](https://space.bilibili.com/15020053)、[萌萌de小公举](https://space.bilibili.com/471306518)等人设计了喷射合成站等机器；国外的同时期历史相似，也是需求①催生了储电的开端——[SCI](https://www.youtube.com/watch?v=cSdG-GxQXHo)服务器研发的第一台[Main Storage]()。

这一时期国内外间的沟通甚少，参与人员较少但非常重要。一是将储电从生电中独立出来，二是奠定了全物品的基础。

- 近代

如果说新生代是萌芽，那么近代就是长根。在全物品方面，国外率先使用盒子作为处理主题，并研发出了并行卸货；国内的麋鹿引入了“整流”的概念。不久后慕斯白设计了基于自适应水流堆分的物品流整流（国内流行最早的整流器）。整流的提出使全物品的处理能力普遍提高了约12倍之多！可以说这是近代储电最重要的产物了。

此外，全物品还有许多重要的转变：大宗的打包和储存分割开来，诞生出许多打包机、大宗仓库和空盒仓库，并引发了盒分类和箱盒展示的发展；不可堆叠处理更加复杂，催生了盒填充度分类、拆包机、粗盒分类等的发展，尤其是大幅优化了盒处理流程；早期分流技术也开始应用，不过效果不那么好；编码技术开始发展，国外率先设计出完整的编码全物品。

而在非全物品领域，由于生电高速发展，收集也跟着发展，尤其是刷怪类收集；熔炉组、炼药机等生电机器逐渐转为储电机器；自适应技术萌芽，自适应打包、MIS等在近代早期就开始出现，有些用于全物品，有些用于收集或单独使用。

近代储电时间并不长，因为很快就迎来了技术革命。近代储电末期，重要的1.19版本发布了！

- 现代

1.19漏斗矿车掉落机制的改革使矿车机器成为新的技术突破口，不过一开始还仅仅是一些很生硬、简单的应用，直到完整的矿车分、整流器面世才进入现代储电。矿车技术让原本极限的57.6w/h效率成为常态，甚至在收集领域有了288w/h的常态。很快，另一种技术——自适应技术也快速发展起来，二者一结合，全物品大宗处理几乎完全改变了。矿车和盒子两大技术一结合，大宗处理效果直接再翻一番。Temp、合并器、分盒器、Ideal堆分打包、高速分盒器等高精度机器相机出现，储电体系日益扩增。

现代储电的技术增长速度非常快，涉及范围广、参与人员多、创新思路繁、中外交流深。一方面，由需求到实现，储电的实用性越来越高，机器实装、运维成本越来越低，很多偏冷门但对生存有极大便利的技术被深入挖掘；另一方面，知识体系积累到一定程度后，创新思维泉涌，逐渐形成“创储”式创新开路、资深研究者完善优化的机器发展格局，机器质量越来越高。

不过随着储电全的扩大，圈子也出现了不少问题。可谓林子大了什么鸟都有，新人素养参差不齐、圈外大UP胡说八道、抄袭拼接屡见不鲜、吃瓜引战矛盾不断，圈子风气出了问题，很多人都因此退圈，甚至出现了“玩储不混圈，快乐似神仙”之类的箴言。直到现在，问题仍未解决，甚至整个生电乃至于红石圈或多或少都有这样的问题，不过储电圈的问题的严重性是排在最前面几名的。本书初衷之一就是为新人提供一本能不那么依赖圈子学习的资料，笔者也因各种问题退圈，但愿圈子风气能有所好转吧。

目前高精尖技术还比较青涩，或许新时代就是这些正在开发的新技术的时代。这些胃癌科技将在本书末单独成章介绍。

纵观储电发展史，可以发现很多规律：技术早期由需求促成，后期由创新思路+需求促成，技术增长已从高速发展转向高质量发展；技术革命从由机制引发到由思路引发，储电思维越发重要；储电同其他技术间的联系时有加深；储电研究所需要的知识越来越细碎、越来越依赖长时间实验和代码研究；很多先前不重要的技术或思路被重新挖掘出价值，储电派系增多且趋于极化。

## 0.3 储电学习前置

储电入门非常简单，弹药深入研究的话必须有扎实的红石、生电和数学基础，甚至很多时候还要翻源码、写程序（[当然，笔者这种懒狗一般吃现成饭]<deleteline>）；同时，也必须熟知各种常见的辅助mod、资源网站等等；最重要的是，培养实验实践能力、创新精神和批判性思维。

### 0.3.1 生电-红石基础

有关生电学习并没有现成的、系统的资源，大多依赖平时学习了解特性机制的习惯。建议读者经常在B站找特性机制的科普视频，如果加入了正规生电服或生电/红石交流群，那就最好多看下群友推的各种资料，生电玩家经常分享有意思的东西。同时，个别生电服的审核群提供了学习资料（供未过审人员学习），可以关注下，比如我先前为Peregrine服写的[《MC生电向基础学习资料A版》](https://docs.qq.com/doc/DZUFadXZYVWF5SVRS)等。

至于红石学习，国内没有比[GTMC](https://techmc.wiki)更好的学习资料了。这是由国内红石各圈一线研究者共同编写的入门教材，结合了从底层代码抠出来的信息和实战经历，既严谨细致又实用易懂。主教材并不长，耐心读完、理解透彻对学习红石任何分支都有极大的好处，强烈推荐没系统学过红石基础的读者先去把它研究透彻再回来继续读，因为有很多高级红石只是本书会直接使用，例如微时序、计划刻、BED、TEUD等等。

接下来是一些储电常用的生电/红石机制，市面上的资料没有着重突出储电常用的部分，所以特地列出：

- （1）**掉落物机制**

掉落物（Item）是一类很特殊的实体（Entity），碰撞箱大小为2×2×2像素，拥有5滴血（2.5颗心）的生命值。掉落物在生成后一段时间内若不被拾取（包括玩家、生物、漏斗、漏斗矿车等）就会消失（俗称“刷掉了”），这个时间一般是5min，只有一个例外：杀死凋零所掉落的、未被玩家拾取过的下界之星，其刷新时间为10min。

掉落物的运动机制很复杂，有一篇专门的[论文]()可以参考，不过太过于细致了，我们一般是通过经验判断和直接实验，没有必要去深入研究、定量计算。

掉落物可以合并。合并条件为①.掉落物种类相同 ②.两个掉落物实体包含的掉落物加权数量和≤64 ④.掉落物存在时间足够。例如：玩家刚扔出的两队掉落物由于存在时间不够，不能合并；两堆同种64堆叠掉落物，一堆有32个，一堆有33个，相加为65>64，所以也无法合并。

掉落物运动是离散的。离散和连续相对，离散也叫分立。由于MC大多运算都在同一线程内，并且没有真正意义上的多线程机制，所以同一时间内最多执行1此运算，而不是多个运算。我们看到的流畅连续的MC只是由于MC每秒运行20次（循环），频率超过了人体能分辨的最高频率，所以认为看到的图像是连续的（所有游戏都是这样，不止MC）。因此，实际上掉落物的运行情况是，每秒移动20次（正常情况下），每次运动都是瞬移到计算好的地方，就和/tp传送一样。并且在同1gt内，也不是所有的掉落物一起运动（没有“同时”这个东西！），而是一个接一个地“tp”。可能有的读者说，用tick freeze和tick step看它们是同时运动的，这是Java的MVC模式（Model-View-Controller）导致的（数据和视图分离，数据更新好了才更新视图）。实际上，大多数运算都是如此，并不同时；其余所有实体也都是离散的，比如TNT、雪球等。

最后是掉落物和子区块。当一堆掉落物在同1gt穿越子区块边界，它们会按ID顺序决定通过后运算的顺序，也就是说ID靠前的掉落物穿越子区块边界后先运算（先“tp”运动），这个顺序会保持到掉落物消失或再次穿越子区块，许多机器因此具有区块性，比如必须在同一子区块或必须在某个元件处跨越子区块等等。

- （2）**比较器性质补充** 

红石比较器（Comperetor）可以间隔1个实体方块检测容器储量。当实体方块充能等级<15时，输出与直接检测容器时相同；当实体方块充能等级≥15时，比较器输出15。此特性称为“容器屏蔽”（容器屏蔽有3个，没特殊说明的话就是指这个容器屏蔽。另外还有两个分别是漏斗和漏斗矿车的容器屏蔽）。

储电经常使用堆肥桶（俗称“粪桶”）+比较器来输出1~6和8的信号，相比于其他红石分支常用的炼药锅，堆肥桶造价更低，且无须担心下雨。拿事物堆肥时，第一次一定会堆叠一层，不过从第二层起，能不能对一层一般是随机的，除了蛋糕——它必定能堆成功，所以在创造研究时一般用蛋糕来填堆肥桶。14洗脑常用蛋糕发出，而其他的常用木桶里放东西生成，有时偶数信号也用啃过的蛋糕。

比较器输出信号改变需要更新，出了常规元件都接受的NC（Neighbor Chance）之外，比较器还接受比较器更新（Comperetor Chance）。比较器更新由容器发出，当容器的物品栏发生变化（物品增、减、替换等等）时容器会发出二阶毗邻比较器更新。又是比较器输入端信息已经改变，但是并没有收到更新，所以输出并未变化。你可能想到BUD（Block Update Detector），不过它并不包括比较器，这种比较器称为CUD(Comperetor Update Detector)，也叫DUD或TEUD。除了可以检测NC外，更重要的是还能检测比较器更新。下图是3种常见的CUD，其中第2种可以做到8gt工作周期，且延迟无方向性/位置性，第1种由于红石粉的更新机制，检测延迟有方向性/位置性。当然，实际使用时一般视情况自行构建CUD而非直接套用。

![img预留位]()

- （3）**★ 漏斗**<br><div style="height: 20px;"></div>
漏斗(Hopper)是储电中最重要、最玄学的元件，没有之一。有关漏斗的常用知识都必须背熟、理透。首先，漏斗是不完整方块，上方凹槽，下方圆锥，具体缺了多少像素不用知道。其次，漏斗具有方块实体，它的大部分运算在TE阶段完成。漏斗在TE阶段先后执行5个主要操作:
    - ①.若CD时长≠0，则CD时长-1，若减后CD时长仍不为0，则跳过后续运算。
    - ②.若漏斗物品栏不为空，且输出端有可接受漏斗输入的容器（如：熔炉、箱子、漏斗矿车等等）则尝试输出1个物品。
    - ③.若漏斗上方有可接受漏斗输出的容器（如：熔炉、粪桶、漏斗矿车等等），则尝试从容器中吸取1个物品。
    - ④.若漏斗上方无可接受漏斗输出的容器（1.21+还需上方方块没有nbt标签`awa=awa`）
    - ⑤.若②、③、④中的尝试成功至少1次，则增加CD时长。一般加8gt，在以下特殊情况下加7gt以保证漏斗传输间隔为8gt：
    
    ![img预留位]()

至于怎么尝试，最好是实践理解，因为文本描述不好懂，不过也有严谨文本描述：

为方便描述，我们对物品栏进行编号。对于箱子、漏斗等玩家可打开物品栏的容器，打开后看到的每一个小格称为1格。每格可以储存1种物品，加权数量上限为64.按照文字书写习惯对格编号，即从左往右、从上往下，每行标完从下一行最左侧起接着编，如下图：

![img预留位]()

②的尝试：对输出容器的可接受漏斗输入的物品栏进行编号，设该物品栏为$\Omega$，第$n$格为$\Omega_{n}$，漏斗物品栏为$\Omega '$，第m格为$\Omega_{m}'$。从$\Omega_{1}$开始依次访问每一格($\Omega_{1}→\Omega_{2}→…→\Omega_{n}$)，若$\Omega_{n} = \varnothing$，则依次访问$\Omega_{1}'→\Omega_{2}'→…→\Omega_{m}'$直到$\Omega_{m}'\neq\varnothing$且$\Omega_{n}$和$\Omega_{m}'$内物品种类相同，则取$\Omega_{m}'$内的1个物品放入$\Omega_{n}$并结束尝试（成功）；若无$\Omega_{m}$满足条件，或$\Omega_{n}$中物品加权数量为64，则终止对$\Omega_{n}$的访问，开始访问$\Omega_{n+1}$继续判定。若访问完$\Omega$后未成功，则终止尝试（失败）。

③的尝试：同理，设上方容器接受漏斗输出的物品栏及每格分别为$\Omega$和$\Omega_{n}$，漏斗物品栏及每格为$\Omega'$和$\Omega_{n}'$。从$\Omega_{1}'$开始依次访问$\Omega'$的每一格，若$\Omega_{m}'\neq\varnothing$，则依次访问$\Omega_{1}→\Omega_{2}→…→\Omega_{n}$直到$\Omega_{n}\neq\varnothing$且$\Omega_{n}$和$\Omega_{m}'$内物品种类相同，则取$\Omega_{n}$中的1个物品放入$\Omega_{m}'$并结束尝试（成功）；若无$\Omega_{n}$满足条件，或$\Omega_{m}'$中物品加权数量为64，则终止对$\Omega_{m}'$的访问，开始访问$\Omega_{m+1}'$继续判定，若访问完$\Omega'$后未成功，则终止尝试（失败）。

④的尝试：在漏斗上方方块中搜寻，若有掉落物实体的碰撞箱全部或部分在上方方块中，则进行同②、③类似的吸取尝试。

这些表述很抽象，实际上也没人记，因为但凡玩过几个月MC的基本都知道具体的尝试是怎么样的。

对于漏斗的工作机制，也可参考[Fanzhitianyu]()的[源码分析]()、[MC Wiki]()等，以及下方的图解。

![img预留位]()

漏斗分为主动漏斗和被动漏斗。主动漏斗指会“漏”的漏斗，而被动漏斗指只“吸”的漏斗。主动漏斗上下串联就形成了双倍速漏斗，如下图，中间的漏斗会主动吸取上面的漏斗，上面的漏斗也会主动往下漏，所以是双倍速的。漏斗被充能时，不会进行运算②~⑤。

[漏斗哈希]<green>是一个抽象的知识点。吸纳有一个区块C，玩家先后在区块C中放下漏斗$H_{1}$和$H_{2}$（放置两漏斗之间未卸载区块C），则在区块C被卸载前，每gt的TE阶段先执行漏斗$H_{1}$的运算，再执行$H_{2}$的运算。可当区块C被重载后，$H_{1}$、$H_{2}$的运算会按照新的顺序进行，该顺序在区块C被加载时由哈希算法（可以简单理解伪随机）确定，即在区块C被卸载前，$H_{1}$、$H_{2}$的运算顺序都是该既定顺序，直到下一次区块C重载，才可能改变顺序。上述特性被称为[漏斗哈希]<green>。

![img预留位]()